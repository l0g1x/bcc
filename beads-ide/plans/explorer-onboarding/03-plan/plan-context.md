# Codebase Analysis: explorer-onboarding

**Generated:** 2026-02-24
**Source:** 3-agent parallel exploration

---

## Architecture Overview

### Project Structure

The beads-ide monorepo uses **pnpm workspaces** with the following layout:

```
beads-ide/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ backend/          Hono HTTP server (Node.js, port 3001)
â”‚   â””â”€â”€ frontend/         React 19 SPA (Vite, port 5173)
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/           Shared TypeScript types and utilities (@beads-ide/shared)
â”œâ”€â”€ biome.json            Linting/formatting config
â”œâ”€â”€ package.json          Root workspace scripts
â”œâ”€â”€ pnpm-workspace.yaml   pnpm monorepo definition
â””â”€â”€ tsconfig.base.json    Shared compiler options (ES2022, strict, bundler moduleResolution)
```

Each package is independently buildable. The `shared` package is the only cross-package dependency, consumed via `workspace:*` references.

### Backend Architecture (`apps/backend/src/`)

**Entry point and routing:**
```
apps/backend/src/
â”œâ”€â”€ index.ts          Hono app entry, route registration, server startup (port 3001)
â”œâ”€â”€ config.ts         BeadsConfig, resolveProjectRoot, getFormulaSearchPaths, loadConfig, getConfig, clearConfigCache
â”œâ”€â”€ cli.ts            runCli, bdCook, gtSling, bdPour, bdBurn, bvGraph, bvInsights, validation helpers
â””â”€â”€ routes/
    â”œâ”€â”€ health.ts     GET /api/health, GET /api/config
    â”œâ”€â”€ formulas.ts   GET/PUT /api/formulas, GET/PUT /api/formulas/:name, POST /api/formulas/:name/cook, POST /api/formulas/:name/sling
    â”œâ”€â”€ cook.ts       POST /api/cook
    â”œâ”€â”€ sling.ts      POST /api/sling
    â”œâ”€â”€ pour.ts       POST /api/pour
    â”œâ”€â”€ beads.ts      Bead-related routes
    â”œâ”€â”€ graph.ts      GET /api/graph, GET /api/metrics
    â””â”€â”€ workspace.ts  [NEW] Workspace management routes
```

Each route file exports a named Hono sub-app that is mounted in `index.ts` via `app.route('/api', routeName)`. There is no middleware layer â€” each route handler calls `getConfig()` directly and uses `cli.ts` helpers for CLI invocations.

**Config management pattern:** `config.ts` maintains a module-level singleton (`cachedConfig: BeadsConfig | null`). All routes call `getConfig()` which returns the cached instance. `clearConfigCache()` + `loadConfig(newPath)` is the mechanism to hot-swap the workspace root without process restart.

Key config functions:
- `resolveProjectRoot(startDir)` â€” walks up finding `.beads/` directory
- `getFormulaSearchPaths(projectRoot)` â€” returns existing paths among `formulas/`, `.beads/formulas/`, `~/.beads/formulas/`, `$GT_ROOT/.beads/formulas/`
- `getConfig()` â€” returns cached config, loading on first call
- `clearConfigCache()` â€” sets `cachedConfig = null`
- `loadConfig(cwd)` â€” creates a fresh `BeadsConfig` from scratch

### Frontend Architecture (`apps/frontend/src/`)

```
apps/frontend/src/
â”œâ”€â”€ main.tsx              Router setup, context tree bootstrap, render root
â”œâ”€â”€ App.tsx               Legacy component (unused in routing flow)
â”œâ”€â”€ app.css               Tailwind 4 @theme definitions + global styles
â”œâ”€â”€ routeTree.gen.ts      Auto-generated by TanStack Router â€” DO NOT EDIT
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ __root.tsx        Root layout: ErrorBoundary, providers, AppShell, FormulaTree, CommandPalette
â”‚   â”œâ”€â”€ index.tsx         / route â€” currently renders LandingPage
â”‚   â”œâ”€â”€ formula.$name.tsx /formula/:name route â€” formula editor
â”‚   â””â”€â”€ results.$id.tsx   /results/:id route â€” result viewing
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ layout/           AppShell, Sidebar, FormulaTree, CommandPalette, PanelResizer
â”‚   â”œâ”€â”€ formulas/         TextEditor, VisualBuilder, FormulaFlowView, SlingDialog, PourDialog
â”‚   â”œâ”€â”€ ui/               UnsavedChangesModal, OfflineBanner, GenericErrorPage, ConnectionGate
â”‚   â”œâ”€â”€ beads/            BeadDetail
â”‚   â”œâ”€â”€ results/          Result viewing components
â”‚   â”œâ”€â”€ preview/          Preview components
â”‚   â””â”€â”€ opencode/         AI terminal
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ announcement-context.tsx    Screen reader announcements
â”‚   â”œâ”€â”€ bead-selection-context.tsx  Selected bead tracking
â”‚   â”œâ”€â”€ formula-dirty-context.tsx   Tracks dirty formula names (Set<string>)
â”‚   â””â”€â”€ formula-save-context.tsx    Registered save handler (ref-based, single formula)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-formulas.ts       Fetches GET /api/formulas, returns FormulaListItem[]
â”‚   â”œâ”€â”€ use-formula-content.ts  Fetches GET /api/formulas/:name
â”‚   â”œâ”€â”€ use-cook.ts           Debounced cook requests
â”‚   â”œâ”€â”€ use-save.ts           PUT /api/formulas/:name
â”‚   â”œâ”€â”€ use-sling.ts          POST /api/sling
â”‚   â”œâ”€â”€ use-pour.ts           POST /api/pour
â”‚   â”œâ”€â”€ use-hotkeys.ts        Global hotkey registration
â”‚   â”œâ”€â”€ use-keyboard-tip.ts   One-time Cmd+K toast (localStorage flag)
â”‚   â”œâ”€â”€ use-bead.ts           Bead fetching
â”‚   â”œâ”€â”€ use-graph.ts          Graph metrics
â”‚   â”œâ”€â”€ use-opencode.ts       AI terminal
â”‚   â”œâ”€â”€ use-workspace-config.ts [NEW] localStorage WorkspaceConfig management
â”‚   â””â”€â”€ use-tree.ts           [NEW] Fetch GET /api/tree
â””â”€â”€ lib/
    â”œâ”€â”€ api.ts                apiFetch/apiPost/apiPut wrappers, connection state, toast helpers
    â”œâ”€â”€ formula-parser.ts     TOML parse + validate
    â””â”€â”€ (other utilities)
```

**Context provider stack in `__root.tsx`:**
```
ErrorBoundary
  â””â”€â”€ BeadSelectionProvider
        â””â”€â”€ FormulaSaveProvider
              â””â”€â”€ RootLayoutInner
```

**Important:** `FormulaDirtyProvider` is conspicuously absent from `__root.tsx`. `useFormulaDirty()` is called by both `FormulaTree` and `formula.$name.tsx`, but neither shows a `FormulaDirtyProvider` wrapping them in `__root.tsx`. This must be verified and corrected during implementation â€” `FormulaDirtyProvider` must wrap `RootLayoutInner` if it is currently missing.

### Shared Package (`packages/shared/src/`)

```
src/
â”œâ”€â”€ ide-types.ts    All shared API types: Formula, CookResult, SlingResult, PourResult, GraphMetrics, etc.
â”œâ”€â”€ types.ts        Additional types
â”œâ”€â”€ formula-parser.ts  Formula parsing utilities
â”œâ”€â”€ wave.ts         Wave-related utilities
â””â”€â”€ index.ts        Re-exports from all modules
```

### Dependency Graph

```
frontend â”€â”€depends onâ”€â”€â–¶ @beads-ide/shared
backend  â”€â”€depends onâ”€â”€â–¶ @beads-ide/shared
```

No dependencies between frontend and backend. All communication is via HTTP. Types are shared via `@beads-ide/shared`.

### State Management

- **No Redux or Zustand.** All state is React Context + component-local `useState`.
- **No React Query or SWR.** Data fetching is manual `useEffect` + `useState` in each hook.
- **Connection state** is a module-level singleton in `lib/api.ts` with a listener set.
- **localStorage** is used directly for panel sizes (`app-shell.tsx`), keyboard tips (`use-keyboard-tip.ts`), and will be used for workspace config.

---

## Integration Surface

### Files That Will Need Modification

#### 1. `/apps/backend/src/config.ts`

**Change type:** Modify (add workspace root override mechanism)

The spec requires the backend to maintain a mutable workspace root separate from `process.cwd()`. The current module exports only `loadConfig`, `getConfig`, and `clearConfigCache`. No workspace root override mechanism exists.

Required additions:
- A new module-level variable `let workspaceRoot: string | null = null`
- `setWorkspaceRoot(path: string): void` â€” sets the override root and clears the config cache
- `getWorkspaceRoot(): string` â€” returns `workspaceRoot ?? process.cwd()`
- Update `loadConfig(cwd)` default argument to use `getWorkspaceRoot()` instead of `process.cwd()`
- Update `getConfig()` to pass `getWorkspaceRoot()` when calling `loadConfig()`

This mechanism enables `POST /api/workspace/open` and `POST /api/workspace/init` to change the active root without restarting the process. The existing `clearConfigCache()` is the right hook â€” it needs a companion `workspaceRoot` variable.

**Existing signatures (do not change):**
- `getConfig(): BeadsConfig` â€” called by every route handler
- `clearConfigCache(): void` â€” called nowhere currently; will be called by new workspace routes
- `resolveProjectRoot(startDir: string): string` â€” pure, no change needed
- `getFormulaSearchPaths(projectRoot: string): string[]` â€” pure, no change needed

#### 2. `/apps/backend/src/index.ts`

**Change type:** Modify (add workspace route registration)

Add the new workspace route group to the Hono app:
```typescript
import { workspace } from './routes/workspace.js'
// ...
app.route('/api', workspace)
```

The `.js` extension is required â€” this is an ESM project and TypeScript resolves `.ts` source files through `.js` extensions.

#### 3. `/apps/frontend/src/routes/__root.tsx`

**Change type:** Modify (add FormulaDirtyProvider, workspace config hook, sidebar content, command palette handlers)

Changes required:
1. **Add `FormulaDirtyProvider`** to the context tree if it is missing (needed for workspace tree dirty indicators)
2. **Import and call `useWorkspaceConfig`** hook for startup sync with `GET /api/workspace`
3. **Add handlers**: `onOpenFolder`, `onNewProject`, `onChangeFolder` â€” pass them to `useDefaultActions`
4. **Update `sidebarContent` prop**: render `WorkspaceHeader` + `WorkspaceTree` or `WelcomePanel` based on `workspaceConfig.rootPath`
5. **Update `useDefaultActions` call** to pass new workspace handlers
6. **Add `document.title` management**: `[formula name] - Beads IDE`

#### 4. `/apps/frontend/src/routes/index.tsx`

**Change type:** Modify (conditional welcome screen rendering)

Per spec: "The welcome screen is a conditional state of the `/` route, not a separate route."

Required changes:
- Import `useWorkspaceConfig` hook
- If `rootPath` is null/missing, render `<WelcomePanel />` instead of the current greeting
- If `rootPath` is set, render the existing landing page content (or a blank page, since the tree is in the sidebar)
- Update the browser `<title>` tag based on current formula: `document.title = formulaName ? \`${formulaName} - Beads IDE\` : 'Beads IDE'`

#### 5. `/apps/frontend/src/components/layout/sidebar.tsx`

**Change type:** Modify (replace text toggle with chevron SVG icons)

Per spec section 3.2:
- Replace `'>'` / `'<'` text toggle with chevron SVG icons (`â€¹` / `â€º`)
- The header area needs to accommodate the `WorkspaceHeader` component

Current `SidebarProps`:
```typescript
interface SidebarProps {
  children?: ReactNode
  collapsed?: boolean
  onToggleCollapse?: () => void
}
```

No signature change needed â€” `Sidebar` is a layout shell that receives `children`. The `WorkspaceHeader` will be passed as part of `children` or as a new `headerContent` prop if needed.

#### 6. `/apps/frontend/src/components/layout/command-palette.tsx`

**Change type:** Modify (`useDefaultActions` signature extension)

`useDefaultActions` signature must be extended with new workspace handler props:
```typescript
export function useDefaultActions(handlers: {
  onOpenFormula?: () => void
  onCookPreview?: () => void
  onSling?: () => void
  onSwitchToGraph?: () => void
  onSwitchToList?: () => void
  onSwitchToWave?: () => void
  onOpenFolder?: () => void      // NEW
  onNewProject?: () => void      // NEW
  onChangeFolder?: () => void    // NEW
}): CommandAction[]
```

New actions to add in the returned array:
```typescript
{
  id: 'open-folder',
  label: 'Open Folder...',
  description: 'Open a project folder',
  icon: 'ðŸ“',
  category: 'Workspace',
  onSelect: handlers.onOpenFolder || (() => {}),
},
{
  id: 'new-project',
  label: 'New Project...',
  description: 'Create a new Beads project',
  icon: 'âœ¨',
  category: 'Workspace',
  onSelect: handlers.onNewProject || (() => {}),
},
{
  id: 'change-folder',
  label: 'Change Folder...',
  description: 'Switch to a different project folder',
  icon: 'ðŸ”„',
  category: 'Workspace',
  onSelect: handlers.onChangeFolder || (() => {}),
},
```

#### 7. `/apps/frontend/src/components/layout/index.ts`

**Change type:** Modify (add exports for new layout components)

```typescript
export { WorkspaceTree } from './workspace-tree'
export { WorkspaceHeader } from './workspace-header'
export { WelcomePanel } from './welcome-panel'
export { NewProjectModal } from './new-project-modal'
export { DirectoryBrowser } from './directory-browser'
```

#### 8. `/apps/frontend/src/hooks/index.ts`

**Change type:** Modify (export new hooks)

```typescript
export { useWorkspaceConfig } from './use-workspace-config'
export { useTree } from './use-tree'
```

#### 9. `/packages/shared/src/ide-types.ts`

**Change type:** Modify (append new types)

Add all new shared types (full definitions detailed in Shared Types section below):
```typescript
export interface TreeNode { ... }
export interface TreeResponse { ... }
export interface TreeError { ... }
export interface WorkspaceOpenRequest { ... }
export interface WorkspaceOpenResponse { ... }
export interface WorkspaceInitRequest { ... }
export interface WorkspaceInitResponse { ... }
export interface WorkspaceStateResponse { ... }
export interface WorkspaceError { ... }
```

#### 10. `/packages/shared/src/index.ts`

**Change type:** Modify (export new types)

```typescript
export type {
  TreeNode,
  TreeResponse,
  TreeError,
  WorkspaceOpenRequest,
  WorkspaceOpenResponse,
  WorkspaceInitRequest,
  WorkspaceInitResponse,
  WorkspaceStateResponse,
  WorkspaceError,
} from './ide-types.js'
```

#### 11. `/apps/frontend/package.json`

**Change type:** Modify (add @tanstack/react-virtual dependency)

This package is NOT currently in `apps/frontend/package.json`. It must be added before implementing the virtualized `WorkspaceTree`:
```bash
pnpm add @tanstack/react-virtual --filter @beads-ide/frontend
```

### New Files to Create

#### 1. `/apps/backend/src/routes/workspace.ts`

**New Hono route file** with endpoints:
- `GET /api/workspace` â€” returns `WorkspaceStateResponse` (current root, formula count, search paths)
- `POST /api/workspace/open` â€” validates path, calls `setWorkspaceRoot()`, clears config cache
- `POST /api/workspace/init` â€” scaffolds `.beads/` + `formulas/` dirs, writes template file, then calls open logic
- `GET /api/tree` â€” recursive async scan returning `TreeResponse`
- `GET /api/browse` â€” directory browser for the `DirectoryBrowser` UI component

Key function signatures internally:
```typescript
async function scanTree(root: string, limit: number): Promise<{ nodes: TreeNode[], totalCount: number, truncated: boolean }>
async function hasFormulaDescendant(dir: string): Promise<boolean>
```

The scan uses `fs.promises.readdir` and `fs.promises.stat` (async).

#### 2. `/apps/frontend/src/hooks/use-workspace-config.ts`

Manages `localStorage.workspaceConfig` with version guard and rich schema:

```typescript
interface WorkspaceConfig {
  version: 1
  rootPath: string | null
  recentRoots: string[]
  treeExpanded: Record<string, Record<string, boolean>>  // rootPath -> dirPath -> expanded
}

export function useWorkspaceConfig(): {
  config: WorkspaceConfig
  setRootPath: (path: string | null) => void
  addRecentRoot: (path: string) => void
  setTreeExpanded: (rootPath: string, dirPath: string, expanded: boolean) => void
  clearConfig: () => void
}
```

Implements version guard: if `localStorage.workspaceConfig` is missing or version !== 1, initialize to defaults. Always wrap localStorage in try/catch (following existing patterns in `use-keyboard-tip.ts` and `app-shell.tsx`).

#### 3. `/apps/frontend/src/hooks/use-tree.ts`

Fetches `GET /api/tree` using `apiFetch` from `lib/api.ts`:

```typescript
export interface UseTreeReturn {
  nodes: TreeNode[]
  root: string | null
  totalCount: number
  truncated: boolean
  isLoading: boolean
  error: Error | null
  refresh: () => void
  lastUpdated: Date | null
}

export function useTree(): UseTreeReturn
```

Pattern mirrors `use-formulas.ts`: `useEffect` + `useState`, returns structured state. The `lastUpdated` field is used for the refresh button tooltip in the sidebar header.

#### 4. `/apps/frontend/src/components/layout/workspace-tree.tsx`

Contains: `WorkspaceTree`, `DirectoryNode`, `FormulaNode`, `EmptyState`, `NodeLimitBanner`, `LoadingSkeleton`, `TreeErrorState`.

Key internal types:
```typescript
interface FlatTreeItem {
  id: string
  path: string
  name: string
  type: 'directory' | 'formula'
  formulaName?: string
  depth: number
  isExpanded?: boolean
  isDirty?: boolean
}
```

Consumes:
- `useTree()` â€” tree data
- `useFormulaDirty()` from `contexts/formula-dirty-context.tsx` â€” `isDirty(name: string)` function
- `useWorkspaceConfig()` â€” for expand/collapse persistence
- `useFormulaSave()` from `contexts/formula-save-context.tsx` â€” for UnsavedChangesModal before navigation
- `UnsavedChangesModal` from `components/ui/unsaved-changes-modal.tsx`

Navigation pattern (matches `FormulaTree` exactly):
```typescript
window.history.pushState({}, '', `/formula/${encodeURIComponent(formulaName)}`)
window.dispatchEvent(new PopStateEvent('popstate'))
```

Requires `@tanstack/react-virtual` for virtualization.

#### 5. `/apps/frontend/src/components/layout/workspace-header.tsx`

Contains: `WorkspaceHeader`, `RootPathDisplay`, `RefreshButton`, `ChangeFolderButton`.

Consumes:
- `useWorkspaceConfig()` â€” for root path display
- `useTree()` â€” for `refresh()` and `lastUpdated`
- `useFormulaDirty()` â€” via Change Folder button (triggers `UnsavedChangesModal`)
- `UnsavedChangesModal` from `components/ui/unsaved-changes-modal.tsx`

Change Folder button triggers `DirectoryBrowser` modal and calls `POST /api/workspace/open` via `apiPost`.

#### 6. `/apps/frontend/src/components/layout/welcome-panel.tsx`

Contains: `WelcomePanel`, `RecentList`, `RecentItem`.

Consumes:
- `useWorkspaceConfig()` â€” for `recentRoots`, `setRootPath`, `addRecentRoot`
- `apiPost` from `lib/api.ts` â€” for `POST /api/workspace/open`
- `DirectoryBrowser` modal â€” for folder picking
- `NewProjectModal` â€” for new project flow

Validates recent paths by calling `GET /api/browse?path=<p>` to check existence. Shows warning icon for missing paths.

#### 7. `/apps/frontend/src/components/layout/new-project-modal.tsx`

Contains: `NewProjectModal`, `TemplatePicker`.

Triggered after folder selection for "New Project". Calls `POST /api/workspace/init`.

Uses native `<dialog>` element with `showModal()` for proper focus trapping (WCAG 2.1 AA), following the pattern in `UnsavedChangesModal`.

#### 8. `/apps/frontend/src/components/layout/directory-browser.tsx`

The spec's folder-picker resolution replaces the File System Access API with a backend-driven directory browser. This is a NEW component not in the original spec section 4.4 component list, but specified in the final resolution.

```typescript
interface DirectoryBrowserProps {
  isOpen: boolean
  onSelect: (path: string) => void
  onCancel: () => void
  initialPath?: string
}
```

Consumes:
- `apiFetch` from `lib/api.ts` â€” for `GET /api/browse?path=<path>`

The backend `GET /api/browse` endpoint returns:
```typescript
{ entries: [{ name: string, type: 'dir' | 'file', path: string }] }
```

Uses native `<dialog>` element for proper focus trapping and accessibility.

#### 9. `/apps/backend/tests/routes/workspace.test.ts`

**Vitest unit tests** for workspace routes and tree scanner. Follow the pattern from `formulas.test.ts` and `graph.test.ts`:
- Create a `new Hono()` app, mount the workspace route
- Test all response codes and error paths
- Mock the CLI dependencies where needed
- For the tree scanner (pure filesystem logic), use fixture directories: create temp dirs with `.formula.toml` files in `beforeAll`, scan them, assert structure

#### 10. `/apps/frontend/tests/e2e/workspace-onboarding.spec.ts`

**Playwright E2E tests** for full onboarding flow. Extend `base.extend<TestFixtures>()` with an `apiMock` fixture. Follow the pattern from existing E2E tests:
- Add workspace API mocks to `ApiMock` class (`page.route` for `/api/workspace`, `/api/tree`, `/api/browse`)
- Write spec tests covering: initial welcome screen, open folder, new project, tree navigation, formula opening, change folder, recent roots
- Performance assertion: tree renders within 500ms for 100-formula fixture

---

## Patterns & Conventions

### Precedent: FormulaTree as Template

The closest existing feature is `FormulaTree` (`/apps/frontend/src/components/layout/formula-tree.tsx`). The new `WorkspaceTree` + `WelcomePanel` should be modeled directly on this:

**Structure of FormulaTree:**
- All inline `CSSProperties` style objects at the top (named: `treeContainerStyle`, `itemStyle`, `itemHoverStyle`, `itemActiveStyle`, etc.)
- SVG icon components defined inline with `aria-hidden="true"` (no external icon library)
- Sub-components defined in the same file, not exported separately
- Main exported component at the bottom with `Props` interface immediately above it
- Navigation via `window.history.pushState` + `window.dispatchEvent(new PopStateEvent('popstate'))`
- `UnsavedChangesModal` mounted unconditionally, controlled by `showModal` state

### Data Fetching Hook Template: useFormulas

**Key file:** `/apps/frontend/src/hooks/use-formulas.ts`

Pattern:
```typescript
export interface UseXxxReturn {
  data: T[]
  isLoading: boolean
  error: Error | null
  refresh: () => void
}

export function useXxx(): UseXxxReturn {
  const [data, setData] = useState<T[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  const doFetch = useCallback(async () => {
    setIsLoading(true)
    setError(null)
    try {
      const result = await fetchXxx()
      setData(result.items)
    } catch (err) {
      setError(err instanceof Error ? err : new Error(String(err)))
      setData([])
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => { doFetch() }, [doFetch])

  return { data, isLoading, error, refresh: doFetch }
}
```

**Important:** `use-formulas.ts` uses raw `fetch` internally. New hooks (`use-tree.ts`, `use-workspace-config.ts`) should use `apiFetch` / `apiPost` from `lib/api.ts` instead, as it handles connection state and error classification.

### localStorage Hook Template: useKeyboardTip

**Key file:** `/apps/frontend/src/hooks/use-keyboard-tip.ts`

Pattern for localStorage reads â€” **always wrap in try/catch** (consistent across codebase):
```typescript
const STORAGE_KEY = 'beads-ide-keyboard-tip-shown'

export function useKeyboardTip(): void {
  useEffect(() => {
    try {
      const shown = localStorage.getItem(STORAGE_KEY)
      if (shown) return
      // ...write logic
      localStorage.setItem(STORAGE_KEY, 'true')
    } catch {
      // Ignore localStorage errors (e.g., private browsing)
    }
  }, [])
}
```

Also see `app-shell.tsx` for the panel-sizing persistence pattern (`loadSavedSizes` / `saveSizes` functions).

### Modal Template: UnsavedChangesModal

**Key file:** `/apps/frontend/src/components/ui/unsaved-changes-modal.tsx`

Modals use native `<dialog>` element with `showModal()` for WCAG 2.1 AA focus trapping:
- `useRef<HTMLDialogElement>` + `dialog.showModal()` / `dialog.close()` in `useEffect`
- Handle `onCancel` for Escape key: `onCancel={(e) => { e.preventDefault(); onCancel() }}`
- Overlay click closes: `onClick` on dialog checks `e.target === e.currentTarget`
- `aria-labelledby` and `aria-describedby` for accessibility

The `NewProjectModal` and `DirectoryBrowser` modal should follow this pattern exactly.

### Backend Route Template: formulas.ts

**Key file:** `/apps/backend/src/routes/formulas.ts`

Pattern for a new route file:
```typescript
import { Hono } from 'hono'
import type { SomeType } from '@beads-ide/shared'
import { getConfig } from '../config.js'

const workspace = new Hono()

function errorResponse(error: string, code: SomeError['code']): SomeError {
  return { ok: false, error, code }
}

workspace.get('/workspace', (c) => {
  try {
    // logic
    return c.json(response)
  } catch (error) {
    return c.json(errorResponse(
      error instanceof Error ? error.message : 'Unknown error',
      'SOME_CODE'
    ), 500)
  }
})

export { workspace }
```

### File Naming Conventions

- Component files: `kebab-case.tsx` (e.g., `formula-tree.tsx`, `app-shell.tsx`)
- Hook files: `use-kebab-case.ts` (e.g., `use-formulas.ts`, `use-hotkeys.ts`)
- Route files: TanStack Router file-based convention under `routes/` (`index.tsx`, `__root.tsx`, `formula.$name.tsx`)
- Backend route files: `kebab-case.ts` under `apps/backend/src/routes/` (e.g., `formulas.ts`, `health.ts`)
- Barrel exports: `index.ts` re-exports from each directory

### Component Structure

1. File-level JSDoc comment
2. Imports (types with `import type`, then values)
3. Style constant objects (`CSSProperties`)
4. SVG icon helper components (not exported)
5. Interface/type definitions for props and internal data structures
6. Sub-components (not exported, defined before they're used)
7. Main exported component
8. Exported `Props` interface immediately above the main component

### Typing Conventions

- React component props interfaces: `XxxProps`
- Hook return interfaces: `UseXxxReturn`
- Context value interfaces: `XxxContextValue`
- Style constants: `xxxStyle` as `CSSProperties`
- Backend route modules: named export matching the feature noun (e.g., `export { workspace }`)
- Shared types: PascalCase interfaces in `ide-types.ts`

### Styling Approach

Inline `CSSProperties` objects are the primary approach (not Tailwind, not CSS modules). Tailwind is present and used in routes, but components in `components/layout/` and `components/ui/` use inline styles exclusively.

Established style values (copy exactly):
- `#2a2d2e` â€” hover background for list items
- `#094771` â€” active/selected item background
- `#fbbf24` â€” dirty indicator amber dot
- `#cccccc` â€” default text
- `#858585` â€” secondary/muted text
- `#3c3c3c` â€” skeleton animation background
- `#252526` â€” sidebar background
- `#1e293b` â€” modal background
- `#334155` â€” modal border color
- `#38bdf8` â€” brand color (cyan-400)
- `22px` â€” standard item height
- `16px` per nesting level â€” indentation

Hover states are tracked with `useState<string | null>` for `hoveredItem`, then style objects are switched inline â€” no CSS `:hover` pseudo-classes.

### No Default Exports (Biome Enforced)

Biome config has `"noDefaultExport": "error"`. All exports must be named:
```typescript
export function FormulaTree(...) {}  // correct
export default FormulaTree           // WRONG
```

### Error Handling

**Frontend:** `apiFetch` in `lib/api.ts` never throws â€” always returns `{ data, error }`:
```typescript
const { data, error } = await apiFetch<TreeResponse>('/api/tree')
if (error) {
  // error.type: 'network' | 'server' | 'client' | 'timeout' | 'parse' | 'unknown'
  return
}
```

User-facing errors: `toast.error(message)` via Sonner. For retryable errors with action button, use the `showSlingError` pattern.

**Backend:** All endpoints follow `{ ok: false, error: string, code: string }` envelope. Each route module defines local `errorResponse(error: string, code: XxxError['code'])` helper. HTTP status codes:
- 400 for validation/client errors
- 404 for not-found
- 500/503 for server errors

Path validation: Input paths must be validated to exist and be directories. Use `path.resolve(requestedPath) === requestedPath` normalization to prevent directory traversal.

### Testing Approach

**Vitest** for unit tests (frontend and backend). **Playwright** for E2E tests (frontend only).

**Backend test pattern** (from `formulas.test.ts`, `graph.test.ts`):
```typescript
const app = new Hono()
app.route('/api', formulas)

const res = await app.request('/api/formulas')
const data = (await res.json()) as FormulaListResponse
expect(data).toHaveProperty('ok', true)
```

Mock CLI dependencies with `vi.spyOn(cli, 'runCli').mockResolvedValue(...)`. Use `beforeEach(() => { vi.restoreAllMocks() })`.

For tree scanner tests, use fixture directories: create temp dirs with `.formula.toml` files in `beforeAll`, scan them, assert structure.

**Frontend E2E pattern** (Playwright): Extend `base.extend<TestFixtures>()` with `apiMock` fixture. Use `page.route(/regex/, handler)` to intercept API calls. Tests use `page.goto()`, `page.waitForLoadState('networkidle')`, and Playwright locators.

**Expected test coverage:**
1. Vitest unit tests for tree scanner logic (fixture dirs)
2. Vitest unit tests for `useWorkspaceConfig` logic (version guard, recentRoots capping)
3. Playwright E2E tests for full onboarding flow, folder switch, search filter, open recent
4. Performance assertion in Playwright: tree renders within 500ms for 100-formula fixture

### Code Review Standards

**Biome linting:** Enforces these rules:
- `noDefaultExport: "error"` â€” named exports only
- `useImportType: "error"` â€” `import type` for type-only imports
- `noNonNullAssertion: "warn"` â€” avoid `!` non-null assertions
- `noExplicitAny: "warn"` â€” avoid `any` type

**Formatter settings:**
- Indent: 2 spaces
- Line width: 100
- Quote style: single quotes
- Semicolons: as needed (omitted at line end)
- Trailing commas: ES5 (objects and arrays, not function params)

When semantic HTML rules are unavoidable, use targeted suppression comments:
```typescript
// biome-ignore lint/a11y/useSemanticElements: intentional ARIA status role
```

**Accessibility:**
- Interactive elements: `aria-label` or `aria-labelledby`
- Loading states: `role="status" aria-live="polite"`
- Decorative SVGs: `aria-hidden="true"`
- Modals: use native `<dialog>.showModal()` for focus trapping
- Landmarks: new sidebar content must be within `<nav aria-label="Formula explorer">`

---

## Key Files Reference

### Backend Files Requiring Changes

| File Path | Change | Purpose |
|-----------|--------|---------|
| `/apps/backend/src/config.ts` | Modify | Add `workspaceRoot` variable, `setWorkspaceRoot()`, `getWorkspaceRoot()` |
| `/apps/backend/src/index.ts` | Modify | Import and mount `workspace` route |
| `/apps/backend/src/routes/workspace.ts` | **Create** | 5 endpoints: GET /api/workspace, POST /api/workspace/open, POST /api/workspace/init, GET /api/tree, GET /api/browse |

### Frontend Files Requiring Changes

| File Path | Change | Purpose |
|-----------|--------|---------|
| `/apps/frontend/src/routes/__root.tsx` | Modify | Add FormulaDirtyProvider, workspace sync effect, sidebar content, handlers, title management |
| `/apps/frontend/src/routes/index.tsx` | Modify | Conditional WelcomePanel rendering |
| `/apps/frontend/src/components/layout/sidebar.tsx` | Modify | Replace text toggle with chevron SVG icons |
| `/apps/frontend/src/components/layout/command-palette.tsx` | Modify | Extend `useDefaultActions` with 3 new workspace actions |
| `/apps/frontend/src/components/layout/index.ts` | Modify | Export new components |
| `/apps/frontend/src/components/layout/workspace-tree.tsx` | **Create** | Tree component with virtualization, dirty indicators, unsaved-changes modal |
| `/apps/frontend/src/components/layout/workspace-header.tsx` | **Create** | Root path display, refresh, change-folder buttons |
| `/apps/frontend/src/components/layout/welcome-panel.tsx` | **Create** | Welcome screen with recent roots, new project option |
| `/apps/frontend/src/components/layout/new-project-modal.tsx` | **Create** | New project flow with template picker |
| `/apps/frontend/src/components/layout/directory-browser.tsx` | **Create** | Backend-powered folder picker modal |
| `/apps/frontend/src/hooks/use-workspace-config.ts` | **Create** | localStorage WorkspaceConfig management |
| `/apps/frontend/src/hooks/use-tree.ts` | **Create** | Fetch GET /api/tree with loading/error states |
| `/apps/frontend/src/hooks/index.ts` | Modify | Export new hooks |
| `/apps/frontend/package.json` | Modify | Add `@tanstack/react-virtual` dependency |

### Shared Type Files

| File Path | Change | Purpose |
|-----------|--------|---------|
| `/packages/shared/src/ide-types.ts` | Modify | Add 8 new workspace-related types |
| `/packages/shared/src/index.ts` | Modify | Re-export new types |

### Test Files to Create

| File Path | Purpose |
|-----------|---------|
| `/apps/backend/tests/routes/workspace.test.ts` | Vitest unit tests for workspace routes and tree scanner |
| `/apps/frontend/tests/e2e/workspace-onboarding.spec.ts` | Playwright E2E tests for full onboarding flow |

---

## Shared Types to Add

All added to `/packages/shared/src/ide-types.ts`:

```typescript
export interface TreeNode {
  name: string
  path: string
  type: 'directory' | 'formula'
  formulaName?: string
  children?: TreeNode[]
}

export interface TreeResponse {
  ok: true
  root: string
  nodes: TreeNode[]
  totalCount: number
  truncated: boolean
}

export interface TreeError {
  ok: false
  error: string
  code: 'NO_ROOT' | 'NOT_FOUND' | 'READ_ERROR'
}

export interface WorkspaceOpenRequest {
  path: string
}

export interface WorkspaceOpenResponse {
  ok: true
  root: string
  formulaCount: number
}

export interface WorkspaceInitRequest {
  path: string
  template?: 'blank'
}

export interface WorkspaceInitResponse {
  ok: true
  root: string
  created: string[]
}

export interface WorkspaceStateResponse {
  ok: true
  root: string
  formulaCount: number
  searchPaths: string[]
}

export interface WorkspaceError {
  ok: false
  error: string
  code: 'NOT_FOUND' | 'NOT_DIRECTORY' | 'PERMISSION_DENIED' | 'ALREADY_INITIALIZED' | 'WRITE_ERROR' | 'NO_ROOT' | 'READ_ERROR'
}
```

**Frontend-only types** (not in shared package):

```typescript
// In use-workspace-config.ts
interface WorkspaceConfig {
  version: 1
  rootPath: string | null
  recentRoots: string[]
  treeExpanded: Record<string, Record<string, boolean>>
}

// In workspace-tree.tsx
interface FlatTreeItem {
  id: string
  path: string
  name: string
  type: 'directory' | 'formula'
  formulaName?: string
  depth: number
  isExpanded?: boolean
  isDirty?: boolean
}

// In directory-browser.tsx
interface BrowseEntry {
  name: string
  type: 'dir' | 'file'
  path: string
}

interface BrowseResponse {
  entries: BrowseEntry[]
}
```

---

## Constraints & Considerations

### 1. FormulaDirtyProvider Presence (Critical)

`useFormulaDirty()` is called by `FormulaTree` and will be called by `WorkspaceTree`, but `FormulaDirtyProvider` is NOT visible in `__root.tsx`'s context tree. The provider is exported from `contexts/index.ts` but its mounting location must be verified at runtime.

**Action:** Before implementing `WorkspaceTree`, verify that `FormulaDirtyProvider` wraps the entire app. If it is missing from `__root.tsx`, add it before `RootLayoutInner`. If it is mounted elsewhere (e.g., inside a formula route component), `WorkspaceTree` may not have access to it â€” in that case, move it to `__root.tsx`.

### 2. Backend Workspace Root Persistence

The current `loadConfig()` always calls `resolveProjectRoot(cwd)` where `cwd` defaults to `process.cwd()`. To support `POST /api/workspace/open`, the module-level `workspaceRoot` variable must persist across config loads.

**Implementation notes:**
- `clearConfigCache()` must NOT reset `workspaceRoot` â€” only the config cache.
- `setWorkspaceRoot()` should clear the config cache so the next `getConfig()` call loads fresh config from the new root.
- Persistence is only for the lifetime of the Node.js process. On process restart, `workspaceRoot` reverts to `null`.

### 3. Frontend Startup Sync Logic

On app startup, the frontend must call `GET /api/workspace` and compare the backend's `root` against `localStorage.workspaceConfig.rootPath`. If they differ (e.g., backend was restarted), clear localStorage and show the welcome screen.

This sync must happen before any tree fetch or route rendering, to avoid a flash of stale data. Implement this as an effect in `__root.tsx` that runs once on mount.

### 4. Navigation Pattern Compatibility

Both `FormulaTree` and `WorkspaceTree` must use the exact same navigation pattern:
```typescript
window.history.pushState({}, '', `/formula/${encodeURIComponent(name)}`)
window.dispatchEvent(new PopStateEvent('popstate'))
```

This is a known TanStack Router workaround. The spec (section 4.8) explicitly mandates using this pattern for `WorkspaceTree`.

### 5. Formula Invalidation After Workspace Change

After `POST /api/workspace/open` succeeds, `useFormulas()` must be refreshed so the formula list reflects the new root's search paths. `useFormulas()` exposes `refresh: doFetch` in its return. The workspace-opening logic (in `WelcomePanel` / `WorkspaceHeader` / command palette handlers) must call this refresh.

Since `useFormulas()` is called inside `FormulaTree` (not globally), either lift the call to `__root.tsx` level or use a global event callback to trigger refresh.

### 6. Tree Scanner Filesystem Operations

Use async FS operations:
```typescript
fs.promises.readdir(dir, { withFileTypes: true })  // returns Dirent[] with .isDirectory() / .isFile()
fs.promises.stat(path)  // for symlink resolution if needed
fs.promises.mkdir(path.join(root, '.beads'), { recursive: true })
fs.promises.writeFile(path.join(root, 'formulas', 'new-formula.formula.toml'), BLANK_TEMPLATE)
```

Using `withFileTypes: true` on `readdir` avoids a separate `stat` call per entry â€” this is the most efficient approach.

### 7. Path Validation & Security

The `GET /api/browse` endpoint must validate paths to prevent directory traversal. Minimum validation: `path.resolve(requestedPath)` must equal the requested path after normalization. Consider allowlisting browsable root paths (e.g., only paths within the user's home directory).

### 8. localStorage Namespacing

Existing keys:
- `'beads-ide-panel-sizes'` â€” panel size persistence
- `'beads-ide-keyboard-tip-shown'` â€” one-time tip flag

New key: `'workspaceConfig'` â€” workspace configuration. No collision with existing keys.

### 9. Virtualization Dependency

`@tanstack/react-virtual` is NOT in `apps/frontend/package.json` and MUST be added before implementing the virtualized `WorkspaceTree`. This is the spec's open question #6.

Command: `pnpm add @tanstack/react-virtual --filter @beads-ide/frontend`

### 10. Biome Configuration Compliance

All new code must comply with Biome's enforced rules:
- `noDefaultExport: "error"` â€” use named exports only
- `useImportType: "error"` â€” use `import type` for type-only imports
- `noNonNullAssertion: "warn"` â€” minimize `!` non-null assertions
- `noExplicitAny: "warn"` â€” avoid `any` type

Running `npm run check` (Biome lint + format) must pass. Use targeted `biome-ignore` comments with reasons when necessary.

### 11. TypeScript Strictness

`tsc --noEmit` must pass across the monorepo. The shared types package (`packages/shared/src/ide-types.ts`) is the source of truth for API shapes â€” new workspace types go there, not in individual app files.

### 12. Architectural Boundaries

- **No new dependencies between `frontend` and `backend` packages.** All communication is via HTTP.
- **No global state store.** Workspace config lives in localStorage (accessed via `useWorkspaceConfig` hook). Tree data lives in React state (`useTree` hook).
- **No new route files need TanStack Router declaration.** `routeTree.gen.ts` is auto-generated from the `routes/` directory.
- **`apiFetch`/`apiPost` pattern for all API calls.** New hooks must use `lib/api.ts`, not raw `fetch`.

---

## Development & Deployment

### Build Configuration Changes

1. **`packages/shared/src/ide-types.ts`** â€” New types added here require the shared package to be rebuilt (workspace:* reference handles this transparently in dev).

2. **`apps/frontend/package.json`** â€” Must add `@tanstack/react-virtual` before implementing `WorkspaceTree`. Command: `pnpm add @tanstack/react-virtual --filter @beads-ide/frontend`.

3. **No Vite config changes needed.** The proxy already forwards `/api/*` to the backend. New endpoints (`/api/workspace`, `/api/tree`, `/api/browse`) are covered automatically.

4. **No new route files need TanStack Router declaration.** The generator runs automatically during `vite dev` / `vite build`.

5. **No Biome config changes.** Existing rules apply to all new files. The `files.ignore` list excludes `*.gen.ts` which is correct.

### Development Setup

```bash
# Run backend
cd apps/backend && npm run dev
# tsx watch src/index.ts  â€” hot-reloads on file change

# Run frontend
cd apps/frontend && npm run dev
# vite --host 127.0.0.1  â€” hot-reloads, proxies /api/* to localhost:3001
```

The Vite proxy is configured in `apps/frontend/vite.config.ts`:
```typescript
proxy: {
  '/api': { target: 'http://localhost:3001', changeOrigin: true }
}
```

### Type Checking

```bash
npm run typecheck          # runs all workspaces
cd apps/frontend && npm run typecheck
cd apps/backend && npm run typecheck
cd packages/shared && npm run typecheck
```

### Linting & Formatting

```bash
npm run lint               # biome lint .
npm run check              # biome check . (lint + format check)
npm run format             # biome format --write .
```

### Testing

```bash
# Backend unit tests
cd apps/backend && npm run test

# Frontend unit tests
cd apps/frontend && npm run test
cd apps/frontend && npm run test:watch

# E2E tests
cd apps/frontend && npm run test:e2e
cd apps/frontend && npm run test:e2e:ui
cd apps/frontend && npm run test:e2e:headed
```

Test files follow the `tests/` directory pattern, NOT co-located with source. Backend tests in `apps/backend/tests/routes/workspace.test.ts`. Frontend tests in `apps/frontend/tests/e2e/workspace-onboarding.spec.ts`.

### Production Build

```bash
npm run build          # runs build in all workspaces
cd apps/frontend && npm run build   # tsc -b && vite build
cd apps/backend && npm run build    # tsc -p tsconfig.build.json
cd apps/backend && npm run start    # node dist/index.js
```
